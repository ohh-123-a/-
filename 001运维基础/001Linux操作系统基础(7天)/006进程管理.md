# 🚀 006 进程管理

------

## 1️⃣⚙️ 进程概念

**进程（Process）** 是系统中正在运行的程序实例，每个进程都有以下特征：

- **PID（进程ID）**：唯一标识一个进程
- **PPID（父进程ID）**：表示由哪个进程创建
- **UID（用户ID）**：进程所属用户

查看进程信息：

```bash
ps aux                   # 显示所有进程（完整格式）
ps -ef | grep java       # 查找指定进程
```

实时查看进程资源使用：

```bash
top                      # 动态监控系统资源
```

📘 **区别：**

| 命令  | 功能说明                           |
| ----- | ---------------------------------- |
| `ps`  | 查看当前时刻的进程快照             |
| `top` | 实时刷新进程状态，动态显示资源占用 |

输出示例：

```bash
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.1  16932  1020 ?        Ss   09:10   0:00 /sbin/init
```

📘 **常见进程状态：**

| 状态 | 含义                     |
| ---- | ------------------------ |
| R    | 运行中（Running）        |
| S    | 睡眠（Sleeping）         |
| D    | 不可中断睡眠（I/O 等待） |
| Z    | 僵尸进程（Zombie）       |
| T    | 暂停（Stopped）          |

示例：

```bash
ps -eo pid,ppid,user,stat,cmd
```

------

## 2️⃣🔍 查看与监控进程

### 🧩 常用命令

```bash
ps -ef                 # 查看所有进程
pstree                 # 树状显示进程关系
htop                   # 更友好的实时监控界面（需安装）
pidof nginx            # 获取程序PID
pgrep sshd             # 按名称查找PID
```

### 示例（top）

```bash
top - 09:45:17 up 1 day,  1 user,  load average: 0.05, 0.10, 0.15
Tasks: 102 total,   1 running, 101 sleeping,   0 stopped,   0 zombie
%Cpu(s):  1.3 us,  0.5 sy,  0.0 ni, 98.2 id,  0.0 wa,  0.0 hi,  0.0 si
KiB Mem :  2048000 total,  1024000 used,  1024000 free
```

📊 **关键指标：**

- `%CPU`：CPU占用率
- `%MEM`：内存占用率
- `TIME+`：累计CPU时间
- `COMMAND`：进程启动命令

**扩展：**
 使用 `top -H -p <pid>` 查看指定进程的线程级CPU使用情况。

------

## 3️⃣🧱 进程控制与后台运行

### 🔧 启动与终止进程

```bash
kill PID            # 终止进程
kill -9 PID         # 强制终止（SIGKILL）
killall nginx       # 终止所有nginx进程
pkill -u user1      # 终止某用户的所有进程
```

### ⏯️ 后台与前台控制

```bash
./script.sh &       # 后台运行脚本
jobs                # 查看后台任务
fg %1               # 将任务1调回前台
bg %1               # 让任务1在后台继续执行
```

### 🧠 nohup守护进程

程序退出终端后仍保持运行：

```bash
nohup python app.py > app.log 2>&1 &
```

查看日志输出：

```bash
tail -f app.log
```

📝 **Tips：**
 生产环境推荐使用 `systemd` 或 `supervisord` 管理长期运行的服务，而非仅靠 `nohup`。

------

## 4️⃣🧮 进程优先级与调度

Linux通过 **nice值（用户态）** 与 **优先级（内核态）** 控制CPU调度。

- nice值范围：`-20`（最高优先级）~ `19`（最低优先级）

```bash
nice -n 10 command         # 启动时指定优先级
renice -n -5 -p 1234       # 修改已运行进程的优先级
ps -eo pid,ni,pri,cmd | head
```

📘 **调度策略：**

| 策略        | 说明                       |
| ----------- | -------------------------- |
| SCHED_OTHER | 默认普通任务（普通用户）   |
| SCHED_FIFO  | 实时先来先服务（实时任务） |
| SCHED_RR    | 实时轮询（实时任务）       |

查看与设置策略：

```bash
chrt -p <pid>              # 查看
sudo chrt -f -p 10 1234    # 设置为FIFO优先级10（root）
```

------

## 5️⃣🐍 僵尸进程与孤儿进程

### 🧟 僵尸进程 (Zombie)

进程结束但父进程未回收资源（状态“Z”）。

```bash
ps aux | grep Z
```

**解决方式：**

1️⃣ 找出父进程 PID：

```bash
ps -ef | grep <zombie_pid>
```

2️⃣ 杀掉或重启父进程：

```bash
kill -HUP <parent_pid>
```

------

### 👶 孤儿进程 (Orphan)

父进程先退出，子进程由 `init` 或 `systemd` 收养。一般安全，但可能导致资源占用。

------

## 6️⃣🔥 CPU占用100%排查与解决

当发现某个进程CPU占用过高：

### ① 找出高CPU进程

```bash
top -o %CPU          # 动态排序
ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%cpu | head
```

### ② 定位线程级别

```bash
top -H -p <pid>
```

找到异常线程后转为16进制：

```bash
printf "%x\n" <tid>
```

结合 `jstack`、`gdb`、`strace` 分析程序逻辑：

```bash
strace -p <pid>           # 查看系统调用
gdb -p <pid>              # 调试定位死循环
```

### ③ 处理方法

- 若为死循环 → 检查程序逻辑
- 若为I/O阻塞 → 查看磁盘/网络延迟
- 若为内存泄漏 → 使用 `pmap` 或 `valgrind`
- 临时处理 → `renice +10 <pid>` 或 `kill -9 <pid>`

------

## 7️⃣📡 系统级进程管理

使用 `systemctl` 管理服务：

```bash
systemctl status sshd
systemctl start nginx
systemctl stop nginx
systemctl enable httpd
```

监控高负载进程：

```bash
top -o %CPU           # 按CPU排序
ps aux --sort=-%mem   # 按内存占用排序
```

结合 `cron` 定期清理异常进程：

```bash
*/10 * * * * pkill -f "python app.py"
```

------

## ✅ 本节总结

| 工具                       | 功能说明             |
| -------------------------- | -------------------- |
| `ps`, `pstree`             | 查看进程信息         |
| `top`, `htop`              | 实时监控CPU/内存     |
| `kill`, `killall`, `pkill` | 终止进程             |
| `nice`, `renice`, `chrt`   | 调整优先级与调度策略 |
| `nohup`, `jobs`, `fg/bg`   | 后台任务管理         |
| `systemctl`, `supervisord` | 服务级进程管理       |
| `strace`, `gdb`            | 深度排查高CPU进程    |

💡 **记忆口诀：**

> “查进程 → 看资源 → 控后台 → 调优先 → 防僵尸 → 查高负 → 管系统”
>  ——Linux进程管理的七步完全体