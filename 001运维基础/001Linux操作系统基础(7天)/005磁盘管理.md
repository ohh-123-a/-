# 💽 005 磁盘管理

------

## 1️⃣💽 磁盘分区

```bash
sudo fdisk -l        # 查看所有磁盘信息
sudo parted /dev/sda # 进入交互式分区工具
lsblk                # 以树形结构显示磁盘与分区关系
```

示例输出：

```bash
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda      8:0    0  256G  0 disk
├─sda1   8:1    0   50G  0 part /
└─sda2   8:2    0  206G  0 part /home
```

### ✳️ 创建分区

```bash
fdisk /dev/sdb
```

常用命令说明：

| 命令 | 功能       |
| ---- | ---------- |
| `n`  | 新建分区   |
| `d`  | 删除分区   |
| `p`  | 显示分区表 |
| `w`  | 写入并退出 |

示例操作：

```bash
命令(输入 m 获取帮助)：n
Partition type: p
分区号 (1-4，默认 1)：1
起始扇区：2048
Last 扇区：+10G
命令(输入 m 获取帮助)：w
```

格式化分区：

```bash
# 格式化分区为xfs文件系统
mkfs.xfs /dev/sdb1
```

------

## 2️⃣ ⚙️ 格式化与挂载

```bash
sudo mkfs.ext4 /dev/sda1       # 格式化为ext4
sudo mkfs.xfs /dev/sda1        # 适合大文件场景
sudo mount /dev/sda1 /mnt      # 临时挂载
sudo umount /mnt               # 取消挂载
```

📘 **文件系统类型对比：**

| 类型  | 特点               | 适用场景         |
| ----- | ------------------ | ---------------- |
| ext4  | 稳定可靠，支持日志 | 桌面、通用服务器 |
| xfs   | 大文件读写性能优   | 日志、数据库等   |
| btrfs | 支持快照与压缩     | 高级系统、虚拟化 |

### 临时挂载目录

```bash
mount -t ext4 /dev/sdb1 /data
```

### 永久挂载

编辑 `/etc/fstab`：

```bash
sudo vim /etc/fstab
```

添加：

```bash
/dev/sdb1   /data   ext4   defaults   0   2
```

字段含义：

| 字段     | 含义                              |
| -------- | --------------------------------- |
| 设备名   | 挂载的磁盘分区                    |
| 挂载点   | 目录位置                          |
| 文件系统 | 如 ext4/xfs                       |
| 选项     | 挂载参数，如 defaults             |
| dump     | 是否备份 (0=否)                   |
| pass     | 启动时检测顺序 (1=根目录, 2=其他) |

✅ 验证挂载：

```bash
sudo mount -a
```

无报错即表示成功。

------

## 3️⃣ 📊 磁盘使用情况

```bash
df -h           # 查看磁盘总体使用率
du -sh /home    # 查看单个目录占用
```

示例输出：

```bash
Filesystem      Size  Used Avail Use% Mounted on
/dev/vda1        40G   26G   13G  68% /
```

------

## 4️⃣ ⚙️ LVM逻辑卷管理与扩容

LVM（Logical Volume Manager）是一种比传统分区更灵活的磁盘管理方式，
 允许在不中断业务的情况下动态扩容、缩容或迁移磁盘数据。

------

### 🧩 原理结构

```bash
┌────────────┐
│  磁盘 Disk │
└──────┬─────┘
       │
       ▼
┌────────────┐
│ PV (物理卷)│
└──────┬─────┘
       │
       ▼
┌────────────┐
│ VG (卷组)  │
└──────┬─────┘
       │
       ▼
┌────────────┐
│ LV (逻辑卷)│ → 格式化 → 挂载点 (/data)
└────────────┘
```

📘 **逻辑关系：**

> PV ➜ VG ➜ LV
>  （物理卷 → 卷组 → 逻辑卷）

类比：

- PV 像砖头
- VG 是砖堆
- LV 是用砖堆砌成的房间（实际使用空间）

------

### 🧱 步骤详解

#### 1️⃣ 创建 PV（Physical Volume）

```bash
pvcreate /dev/sdb1
pvdisplay
```

#### 2️⃣ 创建 VG（Volume Group）

```bash
vgcreate vg_data /dev/sdb1
vgdisplay
```

#### 3️⃣ 创建 LV（Logical Volume）

```
lvcreate -L 8G -n lv_newdata vg_data
```

查看结构：

```bash
lsblk
```

输出示例：

```bash
sdb                      8:16   0   20G  0 disk
└─sdb1                   8:17   0   10G  0 part
  └─vg_data-lv_newdata 253:2    0    8G  0 lvm
```

------

#### 4️⃣ 格式化与挂载 LV

```bash
mkfs.ext4 /dev/vg_data/lv_newdata
mkdir -p /newdata
mount /dev/vg_data/lv_newdata /newdata
```

永久挂载：

```bash
blkid /dev/vg_data/lv_newdata
# 输出UUID后，写入fstab：
UUID=xxxx-xxxx  /newdata  ext4  defaults  0  0
mount -a
```

------

### 📈 模拟扩容实战

#### Step 1：模拟磁盘写满

```bash
dd if=/dev/zero of=/newdata/testfile bs=1M count=20000
# 报错 No space left on device 表示磁盘满
```

#### Step 2：扩容逻辑卷

1. 检查 VG 剩余空间：

```bash
vgs
```

1. 扩展 LV：

```bash
lvextend -L +10G /dev/vg_data/lv_newdata
```

1. 刷新文件系统：

- ext4：

  ```bash
  resize2fs /dev/vg_data/lv_newdata
  ```

- xfs：

  ```bash
  xfs_growfs /newdata
  ```

1. 验证扩容：

```bash
df -h /newdata
```

输出示例：

```bash
Filesystem                    Size  Used Avail Use% Mounted on
/dev/mapper/vg_data-lv_newdata 30G   45M   29G   1% /newdata
```

------

### 🔧 其他常用操作

| 操作            | 命令                                                | 说明                         |
| --------------- | --------------------------------------------------- | ---------------------------- |
| 添加新磁盘      | `pvcreate /dev/sdc1` + `vgextend vg_data /dev/sdc1` | 扩展卷组                     |
| 缩小 LV（慎用） | `lvreduce -L 15G /dev/vg_data/lv_newdata`           | 缩小前必须备份并卸载         |
| 迁移数据        | `pvmove /dev/sdb1 /dev/sdc1`                        | 在不中断服务的情况下迁移数据 |

------

### ⚠️ 注意事项

- **XFS 文件系统无法缩容**（仅支持扩容）。

- 缩小 ext4 前必须执行：

  ```bash
  e2fsck -f /dev/vg_data/lv_newdata
  ```

- 修改分区或逻辑卷前，务必做好 **数据备份**。

- 使用 LVM 时推荐用 **UUID** 挂载，防止设备名变动导致错误。

------

### ✅ 本节总结

| 类别       | 命令                                   | 说明         |
| ---------- | -------------------------------------- | ------------ |
| 创建 PV    | `pvcreate /dev/sdb1`                   | 初始化物理卷 |
| 创建 VG    | `vgcreate vg_data /dev/sdb1`           | 聚合卷组     |
| 创建 LV    | `lvcreate -L 8G -n lv_newdata vg_data` | 创建逻辑卷   |
| 格式化挂载 | `mkfs.ext4` + `mount`                  | 建立文件系统 |
| 扩容 LV    | `lvextend` + `resize2fs`               | 动态扩容     |
| 增加磁盘   | `vgextend`                             | 扩展卷组空间 |
| 迁移数据   | `pvmove`                               | 在线迁移数据 |

💡 **一句话记忆：**

> LVM 就像磁盘的“积木系统”，
>  让你可以在不关机的情况下，灵活拼装、扩容与调整存储空间。