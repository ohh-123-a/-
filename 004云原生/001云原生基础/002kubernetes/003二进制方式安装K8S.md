# 一、安装说明

本文章将演示Rocky 8 二进制方式安装高可用k8s 1.28.0版本。

生产环境中，建议使用小版本大于5的Kubernetes版本，比如1.19.5以后的才可用于生产环境。

# 二、集群安装

## 2.1 基本环境配置

| **主机名**        | **IP地址**                     | **说明**         |
| ----------------- | ------------------------------ | ---------------- |
| k8s-master01 ~ 03 | 192.168.15.101~103             | master节点 * 3   |
| k8s-node01 ~ 02   | 192.168.15.22 \| 192.168.15.33 | worker节点 * 2   |
| k8s-master-lb     | 192.168.15.88                  | keepalived虚拟IP |

请统一替换这些网段，Pod网段和service和宿主机网段不要重复！！！

| **配置信息** | **备注**        |
| ------------ | --------------- |
| 系统版本     | Rocky linux 8.7 |
| Docker版本   | 24.10           |
| Pod网段      | 172.16.0.0/16   |
| Service网段  | 10.96.0.0/16    |

注意：宿主机网段、K8s Service网段、Pod网段不能重复

主机信息，服务器IP地址不能设置成dhcp，要配置成静态IP。



**系统环境：**

```shell
[root@k8s-master01 ~]# cat /etc/redhat-release
Rocky Linux release 8.7 (Green Obsidian)
[root@k8s-master01 ~]# 
```



**各节点配置：**

```shell
192.168.100.61 k8s-master01  # 2C2G 20G
192.168.100.62 k8s-master02  # 2C2G 20G
192.168.100.63 k8s-master03  # 2C2G 20G
192.168.100.69 k8s-master-lb  # VIP 虚拟IP不占用机器资源 # 如果不是高可用集群，该IP为Master01的IP
192.168.100.64 k8s-node01   # 2C2G 20G
192.168.100.65 k8s-node02   # 2C2G 20G
```



**配置****所有节点****hosts文件：**

```shell
[root@k8s-master01 ~]# vim /etc/hosts

127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.100.61 k8s-master01
192.168.100.62 k8s-master02
192.168.100.63 k8s-master03
192.168.100.69 k8s-master-lb   # 如果不是高可用集群，该IP为Master01>的IP
192.168.100.64 k8s-node01
192.168.100.65 k8s-node02
```



**Rocky8****所有节点****配置yum源：**

```shell
[root@k8s-master01 ~]# cd /etc/yum.repos.d/
[root@k8s-master01 yum.repos.d]# ls
bak
[root@k8s-master01 yum.repos.d]# cat >>/etc/yum.repos.d/docker-ce.repo<<'EOF'
> [docker-ce-stable]
> name=Docker CE Stable - $basearch
> baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/$basearch/stable
> enabled=1
> gpgcheck=1
> gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg
> 
> [docker-ce-stable-debuginfo]
> name=Docker CE Stable - Debuginfo $basearch
> baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/debug-$basearch/stable
> enabled=0
> gpgcheck=1
> gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg
> 
> [docker-ce-stable-source]
> name=Docker CE Stable - Sources
> baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/source/stable
> enabled=0
> gpgcheck=1
> gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg
> 
> [docker-ce-test]
> name=Docker CE Test - $basearch
> baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/$basearch/test
> enabled=0
> gpgcheck=1
> gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg
> 
> [docker-ce-test-debuginfo]
> name=Docker CE Test - Debuginfo $basearch
> baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/debug-$basearch/test
> enabled=0
> gpgcheck=1
> gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg
> 
> [docker-ce-test-source]
> name=Docker CE Test - Sources
> baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/source/test
> enabled=0
> gpgcheck=1
> gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg
> 
> [docker-ce-nightly]
> name=Docker CE Nightly - $basearch
> baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/$basearch/nightly
> enabled=0
> gpgcheck=1
> gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg
> 
> [docker-ce-nightly-debuginfo]
> name=Docker CE Nightly - Debuginfo $basearch
> baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/debug-$basearch/nightly
> enabled=0
> gpgcheck=1
> gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg
> 
> [docker-ce-nightly-source]
> name=Docker CE Nightly - Sources
> baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/$releasever/source/nightly
> enabled=0
> gpgcheck=1
> gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg
> EOF
[root@k8s-master01 yum.repos.d]# 
[root@k8s-master01 yum.repos.d]# cat >>/etc/yum.repos.d/Rocky-BaseOS.repo<<'EOF'
> # Rocky-BaseOS.repo
> #
> # The mirrorlist system uses the connecting IP address of the client and the
> # update status of each mirror to pick current mirrors that are geographically
> # close to the client.  You should use this for Rocky updates unless you are
> # manually picking other mirrors.
> #
> # If the mirrorlist does not work for you, you can try the commented out
> # baseurl line instead.
> 
> [baseos]
> name=Rocky Linux $releasever - BaseOS
> #mirrorlist=https://mirrors.rockylinux.org/mirrorlist?arch=$basearch&repo=BaseOS-$releasever
> baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/BaseOS/$basearch/os/
> gpgcheck=1
> enabled=1
> gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-rockyofficial
> EOF
[root@k8s-master01 yum.repos.d]# 
[root@k8s-master01 yum.repos.d]# cat >>Rocky-AppStream.repo<<'EOF'
> # Rocky-AppStream.repo
> #
> # The mirrorlist system uses the connecting IP address of the client and the
> # update status of each mirror to pick current mirrors that are geographically
> # close to the client.  You should use this for Rocky updates unless you are
> # manually picking other mirrors.
> #
> # If the mirrorlist does not work for you, you can try the commented out
> # baseurl line instead.
> 
> [appstream]
> name=Rocky Linux $releasever - AppStream
> #mirrorlist=https://mirrors.rockylinux.org/mirrorlist?arch=$basearch&repo=AppStream-$releasever
> baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/AppStream/$basearch/os/
> gpgcheck=1
> enabled=1
> gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-rockyofficial
> EOF
[root@k8s-master01 yum.repos.d]# ls
bak  docker-ce.repo  Rocky-AppStream.repo  Rocky-BaseOS.repo
[root@k8s-master01 yum.repos.d]# yum clean all
38 个文件已删除
[root@k8s-master01 yum.repos.d]# yum makecache
Rocky Linux 8 - AppStream           3.6 MB/s |  11 MB     00:02    
Rocky Linux 8 - BaseOS              1.6 MB/s | 6.0 MB     00:03    
Docker CE Stable - x86_64            75 kB/s |  49 kB     00:00    
元数据缓存已建立。
[root@k8s-master01 yum.repos.d]# 
```



**所有节点****必备工具安装**

```shell
[root@k8s-master01 yum.repos.d]# cd
[root@k8s-master01 ~]# yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git -y
```



**所有节点****关闭firewalld 、dnsmasq、selinux**

```shell
[root@k8s-master01 ~]# systemctl disable --now firewalld 
[root@k8s-master01 ~]# systemctl disable --now dnsmasq
[root@k8s-master01 ~]# setenforce 0
[root@k8s-master01 ~]# sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/sysconfig/selinux
[root@k8s-master01 ~]# sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config
[root@k8s-master01 ~]# 
```



**所有节点****关闭swap分区，fstab注释swap**

```shell
[root@k8s-master01 ~]# swapoff -a && sysctl -w vm.swappiness=0
vm.swappiness = 0
[root@k8s-master01 ~]# sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab
[root@k8s-master01 ~]# 
```



**所有节点****同步时间**

```shell
[root@k8s-master01 ~]# rpm -ivh https://mirrors.wlnmp.com/rockylinux/wlnmp-release-rocky-8.noarch.rpm
获取https://mirrors.wlnmp.com/rockylinux/wlnmp-release-rocky-8.noarch.rpm
Verifying...                          ################################# [100%]
准备中...                          ################################# [100%]
正在升级/安装...
   1:wlnmp-release-rocky-1-1          ################################# [100%]
[root@k8s-master01 ~]# yum -y install wntp
[root@k8s-master01 ~]# ntpdate time2.aliyun.com
31 Aug 22:43:34 ntpdate[3549]: adjust time server 203.107.6.88 offset +0.000713 sec
[root@k8s-master01 ~]# crontab -e
no crontab for root - using an empty one

*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com
```



**所有节点****配置limit**

```shell
[root@k8s-node02 ~]# ulimit -SHn 65535
[root@k8s-node02 ~]# vim /etc/security/limits.conf
# 末尾添加如下内容
* soft nofile 65536
* hard nofile 131072
* soft nproc 65535
* hard nproc 655350
* soft memlock unlimited
* hard memlock unlimited
```



**Master01****节点免密钥登录其他节点，安装过程中生成配置文件和证书均在Master01上操作，集群管理也在Master01上操作。密钥配置如下：**

```shell
[root@k8s-master01 ~]# ssh-keygen -t rsa
```



**Master01****配置免密码登录其他节点**

```shell
[root@k8s-master01 ~]# for i in k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02;do ssh-copy-id -i .ssh/id_rsa.pub $i;done
```



**Master01****下载安装文件**

```shell
[root@k8s-master01 ~]# cd /root/ ; git clone https://gitee.com/dukuan/k8s-ha-install.git
正克隆到 'k8s-ha-install'...
remote: Enumerating objects: 879, done.
remote: Counting objects: 100% (205/205), done.
remote: Compressing objects: 100% (127/127), done.
remote: Total 879 (delta 90), reused 145 (delta 52), pack-reused 674
接收对象中: 100% (879/879), 19.70 MiB | 2.37 MiB/s, 完成.
处理 delta 中: 100% (354/354), 完成.
[root@k8s-master01 ~]# ls
点名.txt  视频  下载  anaconda-ks.cfg       k8s-ha-install
公共      图片  音乐  dianming.sh           yum.sh
模板      文档  桌面  initial-setup-ks.cfg
[root@k8s-master01 ~]# 
```



**所有节点****升级系统并重启，此处升级没有升级内核**

```shell
[root@k8s-master01 ~]# yum update -y --exclude=kernel* --nobest
[root@k8s-master01 ~]# reboot
```



## 2.2 安装ipvsadm

**所有节点****安装 ipvsadm 及检测系统的工具**

```shell
[root@k8s-master01 ~]# yum install ipvsadm ipset sysstat conntrack libseccomp -y
```



所有节点配置ipvs模块

```shell
[root@k8s-master01 ~]# modprobe -- ip_vs
[root@k8s-master01 ~]# modprobe -- ip_vs_rr
[root@k8s-master01 ~]# modprobe -- ip_vs_wrr
[root@k8s-master01 ~]# modprobe -- ip_vs_sh
[root@k8s-master01 ~]# modprobe -- nf_conntrack
[root@k8s-master01 ~]# vim /etc/modules-load.d/ipvs.conf 
# 加入以下内容
ip_vs
ip_vs_lc
ip_vs_wlc
ip_vs_rr
ip_vs_wrr
ip_vs_lblc
ip_vs_lblcr
ip_vs_dh
ip_vs_sh
ip_vs_fo
ip_vs_nq
ip_vs_sed
ip_vs_ftp
ip_vs_sh
nf_conntrack
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip
# 检查是否加载：
[root@k8s-master01 ~]# lsmod | grep -e ip_vs -e nf_conntrack
ip_vs_sh               16384  0
ip_vs_wrr              16384  0
ip_vs_rr               16384  0
ip_vs                 172032  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr
nf_conntrack          172032  4 xt_conntrack,nf_nat,ipt_MASQUERADEip_vs
nf_defrag_ipv6         20480  2 nf_conntrack,ip_vs
nf_defrag_ipv4         16384  1 nf_conntrack
libcrc32c              16384  5 nf_conntrack,nf_nat,nf_tables,xfs,ip_vs
```



**开启一些k8s集群中必须的内核参数，****所有节点****配置k8s内核：**

```shell
[root@k8s-master01 ~]# cat <<EOF > /etc/sysctl.d/k8s.conf
> net.ipv4.ip_forward = 1
> net.bridge.bridge-nf-call-iptables = 1
> net.bridge.bridge-nf-call-ip6tables = 1
> fs.may_detach_mounts = 1
> vm.overcommit_memory=1
> net.ipv4.conf.all.route_localnet = 1
> 
> vm.panic_on_oom=0
> fs.inotify.max_user_watches=89100
> fs.file-max=52706963
> fs.nr_open=52706963
> net.netfilter.nf_conntrack_max=2310720
> 
> net.ipv4.tcp_keepalive_time = 600
> net.ipv4.tcp_keepalive_probes = 3
> net.ipv4.tcp_keepalive_intvl =15
> net.ipv4.tcp_max_tw_buckets = 36000
> net.ipv4.tcp_tw_reuse = 1
> net.ipv4.tcp_max_orphans = 327680
> net.ipv4.tcp_orphan_retries = 3
> net.ipv4.tcp_syncookies = 1
> net.ipv4.tcp_max_syn_backlog = 16384
> net.ipv4.ip_conntrack_max = 65536
> net.ipv4.tcp_max_syn_backlog = 16384
> net.ipv4.tcp_timestamps = 0
> net.core.somaxconn = 16384
> EOF
[root@k8s-master01 ~]# sysctl --system
```



**所有节点****配置完内核后，重启服务器，保证重启后内核依旧加载**

```shell
[root@k8s-master01 ~]# reboot
[root@k8s-master01 ~]# lsmod | grep --color=auto -e ip_vs -e nf_conntrack
ip_vs_ftp              16384  0
nf_nat                 45056  3 ipt_MASQUERADE,nft_chain_nat,ip_vs_ftp
ip_vs_sed              16384  0
ip_vs_nq               16384  0
ip_vs_fo               16384  0
ip_vs_sh               16384  0
ip_vs_dh               16384  0
ip_vs_lblcr            16384  0
ip_vs_lblc             16384  0
ip_vs_wrr              16384  0
ip_vs_rr               16384  0
ip_vs_wlc              16384  0
ip_vs_lc               16384  0
ip_vs                 172032  24 ip_vs_wlc,ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_fo,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed,ip_vs_ftp
nf_conntrack          172032  4 xt_conntrack,nf_nat,ipt_MASQUERADEip_vs
nf_defrag_ipv6         20480  2 nf_conntrack,ip_vs
nf_defrag_ipv4         16384  1 nf_conntrack
libcrc32c              16384  5 nf_conntrack,nf_nat,nf_tables,xfs,ip_vs
[root@k8s-master01 ~]#
```

# 第三章 基本组件安装

本节主要安装的是集群中用到的各种组件，比如Docker-ce、Kubernetes各组件等

此处建议打个快照

## 3.1 Containerd作为Runtime

**所有节点****安装docker-ce-24.0（如果已经有安装，也需要执行安装升级到最新版）**

```shell
[root@k8s-master01 ~]# yum remove -y podman runc containerd
[root@k8s-master01 ~]# yum install docker-ce docker-ce-cli containerd.io -y
```



**配置Containerd所需的模块（****所有节点****）：**

```shell
[root@k8s-master01 ~]# cat <<EOF | sudo tee /etc/modules-load.d/containerd.conf
> overlay
> br_netfilter
> EOF
overlay
br_netfilter
[root@k8s-master01 ~]# 
```



**所有节点****加载模块：**

```shell
[root@k8s-master01 ~]# modprobe -- overlay
[root@k8s-master01 ~]# modprobe -- br_netfilter
[root@k8s-master01 ~]# 
```



**所有节点****，配置Containerd所需的内核：**

```shell
[root@k8s-master01 ~]# cat <<EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
> net.bridge.bridge-nf-call-iptables  = 1
> net.ipv4.ip_forward                 = 1
> net.bridge.bridge-nf-call-ip6tables = 1
> EOF
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
[root@k8s-master01 ~]# sysctl --system
```



**所有节点****配置Containerd的配置文件：**

（使用 containerd 默认配置生成一个 config.toml 配置文件，并将其内容输出到 /etc/containerd/config.toml 文件中）

```shell
[root@k8s-master01 ~]# mkdir -p /etc/containerd
[root@k8s-master01 ~]# containerd config default | tee /etc/containerd/config.toml
```



所有节点将Containerd的Cgroup改为Systemd：

```shell
[root@k8s-master01 ~]# vim /etc/containerd/config.toml
```



**找到 containerd.runtimes.runc.options，添加 SystemdCgroup = true（如果已存在直接修改，否则会报错），如下图所示：**

![img](https://cdn.nlark.com/yuque/0/2023/png/27632550/1703143336254-7e511d3e-5038-4aae-b0ce-96b51cd86e1a.png)



**所有节点****将 sandbox_image 的 Pause 镜像改成符合自己版本的地址 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9**

![img](https://cdn.nlark.com/yuque/0/2023/png/27632550/1703143336641-29c4d402-c74b-4f24-812a-66e88879c2cd.png)



**所有节点****启动Containerd，并配置开机自启动：**

```shell
[root@k8s-master01 ~]# systemctl daemon-reload
[root@k8s-master01 ~]# systemctl enable --now containerd
Created symlink /etc/systemd/system/multi-user.target.wants/containerd.service → /usr/lib/systemd/system/containerd.service.
[root@k8s-master01 ~]# 
```



**所有节点****配置crictl客户端连接的运行时位置：**

```shell
[root@k8s-master01 ~]# cat > /etc/crictl.yaml <<EOF
> runtime-endpoint: unix:///run/containerd/containerd.sock
> image-endpoint: unix:///run/containerd/containerd.sock
> timeout: 10
> debug: false
> EOF
[root@k8s-master01 ~]# 
```



## 4.2 K8s及etcd安装

**Master01下载kubernetes安装包**

```shell
[root@k8s-master01 ~]# wget https://dl.k8s.io/v1.28.0/kubernetes-server-linux-amd64.tar.gz
```



**master01****下载etcd安装包**

```shell
[root@k8s-master01 ~]# wget https://github.com/etcd-io/etcd/releases/download/v3.5.9/etcd-v3.5.9-linux-amd64.tar.gz
```



**master01****解压kubernetes安装文件**

```shell
[root@k8s-master01 ~]# tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy}
```



**master01****解压etcd安装文件**

```shell
[root@k8s-master01 ~]# tar -zxvf etcd-v3.5.9-linux-amd64.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.5.9-linux-amd64/etcd{,ctl}
etcd-v3.5.9-linux-amd64/etcdctl
etcd-v3.5.9-linux-amd64/etcd
[root@k8s-master01 ~]# kubelet --version
Kubernetes v1.28.0
[root@k8s-master01 ~]# etcdctl version
etcdctl version: 3.5.9
API version: 3.5
[root@k8s-master01 ~]# 
```



**master01****将组件发送到其他节点**

```shell
[root@k8s-master01 ~]# MasterNodes='k8s-master02 k8s-master03'
[root@k8s-master01 ~]# WorkNodes='k8s-node01 k8s-node02'
[root@k8s-master01 ~]# for NODE in $MasterNodes; do echo $NODE; scp /usr/local/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy} $NODE:/usr/local/bin/; scp /usr/local/bin/etcd* $NODE:/usr/local/bin/; done
k8s-master02
kubelet                          100%  106MB 281.6MB/s   00:00    
kubectl                          100%   48MB 302.1MB/s   00:00    
kube-apiserver                   100%  116MB 146.9MB/s   00:00    
kube-controller-manager          100%  112MB 129.0MB/s   00:00    
kube-scheduler                   100%   53MB 144.0MB/s   00:00    
kube-proxy                       100%   52MB 145.7MB/s   00:00    
etcd                             100%   21MB 105.1MB/s   00:00    
etcdctl                          100%   16MB 113.7MB/s   00:00    
k8s-master03
kubelet                          100%  106MB 269.0MB/s   00:00    
kubectl                          100%   48MB 212.2MB/s   00:00    
kube-apiserver                   100%  116MB 150.4MB/s   00:00    
kube-controller-manager          100%  112MB 109.9MB/s   00:01    
kube-scheduler                   100%   53MB 154.3MB/s   00:00    
kube-proxy                       100%   52MB 137.2MB/s   00:00    
etcd                             100%   21MB 126.1MB/s   00:00    
etcdctl                          100%   16MB 105.4MB/s   00:00    
[root@k8s-master01 ~]# for NODE in $WorkNodes; do scp /usr/local/bin/kube{let,-proxy} $NODE:/usr/local/bin/ ; done
kubelet                          100%  106MB 239.4MB/s   00:00    
kube-proxy                       100%   52MB 135.6MB/s   00:00    
kubelet                          100%  106MB 306.6MB/s   00:00    
kube-proxy                       100%   52MB 295.4MB/s   00:00    
[root@k8s-master01 ~]# 
```



**Master01节点****切换到1.28.x分支**

（其他版本可以切换到其他分支，.x即可，不需要更改为具体的小版本）

```shell
[root@k8s-master01 ~]# cd /root/k8s-ha-install && git checkout manual-installation-v1.28.x
分支 'manual-installation-v1.28.x' 设置为跟踪 'origin/manual-installation-v1.28.x'。
切换到一个新分支 'manual-installation-v1.28.x'
[root@k8s-master01 k8s-ha-install]#
```



# 第四章 生成证书

二进制安装最关键步骤，一步错误全盘皆输，一定要注意每个步骤都要是正确的。

所以此处建议打快照！



**Master01****下载生成证书工具**

```shell
[root@k8s-master01 k8s-ha-install]# wget "https://pkg.cfssl.org/R1.2/cfssl_linux-amd64" -O /usr/local/bin/cfssl
[root@k8s-master01 k8s-ha-install]# wget "https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64" -O /usr/local/bin/cfssljson
[root@k8s-master01 k8s-ha-install]# chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson
[root@k8s-master01 k8s-ha-install]#
```

## 4.1 Etcd证书

**所有Master节点****创建etcd证书目录**

```shell
[root@k8s-master01 ~]# mkdir /etc/etcd/ssl -p
[root@k8s-master01 ~]#
```



**所有节点****创建kubernetes相关目录**

```shell
[root@k8s-master01 ~]# mkdir -p /etc/kubernetes/pki
[root@k8s-master01 ~]#
```



**Master01节点****生成etcd证书**

生成证书的CSR文件：证书签名请求文件，配置了一些域名、公司、单位

```shell
[root@k8s-master01 ~]# cd /root/k8s-ha-install/pki
[root@k8s-master01 pki]# cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca   ## 生成etcd CA证书和CA证书的key
2023/09/01 01:03:37 [INFO] generating a new CA key and certificate from CSR
2023/09/01 01:03:37 [INFO] generate received request
2023/09/01 01:03:37 [INFO] received CSR
2023/09/01 01:03:37 [INFO] generating key: rsa-2048
2023/09/01 01:03:37 [INFO] encoded CSR
2023/09/01 01:03:37 [INFO] signed certificate with serial number 344130823394962800880998772770250831901274089808
[root@k8s-master01 pki]# cfssl gencert \
>    -ca=/etc/etcd/ssl/etcd-ca.pem \
>    -ca-key=/etc/etcd/ssl/etcd-ca-key.pem \
>    -config=ca-config.json \
>    -hostname=127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.100.61,192.168.100.62,192.168.100.63 \   # 注意主节点IP地址
>    -profile=kubernetes \
>    etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd
2023/09/01 01:04:39 [INFO] generate received request
2023/09/01 01:04:39 [INFO] received CSR
2023/09/01 01:04:39 [INFO] generating key: rsa-2048
2023/09/01 01:04:39 [INFO] encoded CSR
2023/09/01 01:04:39 [INFO] signed certificate with serial number 467674155326432618988047679680337371584557335423
[root@k8s-master01 pki]#
```



**master01****将证书复制到其他节点**

```shell
[root@k8s-master01 pki]# MasterNodes='k8s-master02 k8s-master03'
[root@k8s-master01 pki]# WorkNodes='k8s-node01 k8s-node02'
[root@k8s-master01 pki]# for NODE in $MasterNodes; do
>      ssh $NODE "mkdir -p /etc/etcd/ssl"
>      for FILE in etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem; do
>        scp /etc/etcd/ssl/${FILE} $NODE:/etc/etcd/ssl/${FILE}
>      done
>  done
etcd-ca-key.pem                  100% 1675     1.0MB/s   00:00    
etcd-ca.pem                      100% 1367     1.7MB/s   00:00    
etcd-key.pem                     100% 1675     1.1MB/s   00:00    
etcd.pem                         100% 1509     1.9MB/s   00:00    
etcd-ca-key.pem                  100% 1675     1.2MB/s   00:00    
etcd-ca.pem                      100% 1367   592.0KB/s   00:00    
etcd-key.pem                     100% 1675     1.5MB/s   00:00    
etcd.pem                         100% 1509     1.3MB/s   00:00    
[root@k8s-master01 pki]#
```

## 4.2 k8s组件证书

**Master01****生成kubernetes证书**

```shell
[root@k8s-master01 pki]# cd /root/k8s-ha-install/pki
[root@k8s-master01 pki]# cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca
2023/09/01 01:06:52 [INFO] generating a new CA key and certificate from CSR
2023/09/01 01:06:52 [INFO] generate received request
2023/09/01 01:06:52 [INFO] received CSR
2023/09/01 01:06:52 [INFO] generating key: rsa-2048
2023/09/01 01:06:53 [INFO] encoded CSR
2023/09/01 01:06:53 [INFO] signed certificate with serial number 700660882784581217234688273261359631764300667154
[root@k8s-master01 pki]# 
```

\# 10.96.0.0是k8s service的网段，如果说需要更改k8s service网段，那就需要更改10.96.0.1，

**# 如果不是高可用集群，192.168.15.88 为 Master01 的 IP**



**Master01** **生成 ca 证书**

```shell
[root@k8s-master01 pki]# cfssl gencert   -ca=/etc/kubernetes/pki/ca.pem  \
> -ca-key=/etc/kubernetes/pki/ca-key.pem  \ 
> -config=ca-config.json   \
> -hostname=10.96.0.1,192.168.15.88,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.15.101,192.168.15.102,192.168.15.103   \
> -profile=kubernetes   \
> apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver
2023/09/01 01:09:03 [INFO] generate received request
2023/09/01 01:09:03 [INFO] received CSR
2023/09/01 01:09:03 [INFO] generating key: rsa-2048
2023/09/01 01:09:03 [INFO] encoded CSR
2023/09/01 01:09:03 [INFO] signed certificate with serial number 700805877078105797489323146582505553062943677004
[root@k8s-master01 pki]# 
```



**Master01****生成apiserver的聚合证书**

Requestheader-client-xxx requestheader-allowwd-xxx:aggerator

```shell
[root@k8s-master01 pki]# cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca
2023/09/01 01:09:49 [INFO] generating a new CA key and certificate from CSR
2023/09/01 01:09:49 [INFO] generate received request
2023/09/01 01:09:49 [INFO] received CSR
2023/09/01 01:09:49 [INFO] generating key: rsa-2048
2023/09/01 01:09:50 [INFO] encoded CSR
2023/09/01 01:09:50 [INFO] signed certificate with serial number 80744563078517085527684184401947310203460343599
[root@k8s-master01 pki]# cfssl gencert   -ca=/etc/kubernetes/pki/front-proxy-ca.pem   \
> -ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem   \
> -config=ca-config.json   \
> -profile=kubernetes   \
> front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client
# 返回结果（忽略警告）
2023/09/01 01:09:56 [INFO] generate received request
2023/09/01 01:09:56 [INFO] received CSR
2023/09/01 01:09:56 [INFO] generating key: rsa-2048
2023/09/01 01:09:56 [INFO] encoded CSR
2023/09/01 01:09:56 [INFO] signed certificate with serial number 269856273999475183076691732446396898422130380732
2023/09/01 01:09:56 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for
websites. For more information see the Baseline Requirements for the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);
specifically, section 10.2.3 ("Information Requirements").
[root@k8s-master01 pki]# 
```



**Master01****生成controller-manage的证书**

```shell
[root@k8s-master01 pki]# cfssl gencert \
> -ca=/etc/kubernetes/pki/ca.pem \
> -ca-key=/etc/kubernetes/pki/ca-key.pem \
> -config=ca-config.json \
> -profile=kubernetes \
> manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager
2023/09/01 01:11:24 [INFO] generate received request
2023/09/01 01:11:24 [INFO] received CSR
2023/09/01 01:11:24 [INFO] generating key: rsa-2048
2023/09/01 01:11:24 [INFO] encoded CSR
2023/09/01 01:11:24 [INFO] signed certificate with serial number 59801199172235379177295009346141259163675889793
2023/09/01 01:11:24 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for
websites. For more information see the Baseline Requirements for the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);
specifically, section 10.2.3 ("Information Requirements").
[root@k8s-master01 pki]# 
```



**注意，如果不是高可用集群，192.168.15.88:8443改为master01的地址，8443改为apiserver的端口，默认是6443**

**set-cluster：****Master01****设置一个集群项**

```shell
[root@k8s-master01 pki]# kubectl config set-cluster kubernetes \
>      --certificate-authority=/etc/kubernetes/pki/ca.pem \
>      --embed-certs=true \
>      --server=https://192.168.15.88:8443 \
>      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
Cluster "kubernetes" set.
[root@k8s-master01 pki]# 
```



**Master01****设置一个环境项**

```shell
[root@k8s-master01 pki]# kubectl config set-context system:kube-controller-manager@kubernetes \
> --cluster=kubernetes \
> --user=system:kube-controller-manager \
> --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
Context "system:kube-controller-manager@kubernetes" created.
[root@k8s-master01 pki]# 
```



**set-credentials：****Master01****设置一个用户项**

```shell
[root@k8s-master01 pki]# kubectl config set-credentials system:kube-controller-manager \
> --client-certificate=/etc/kubernetes/pki/controller-manager.pem \
> --client-key=/etc/kubernetes/pki/controller-manager-key.pem \
> --embed-certs=true \
> --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
User "system:kube-controller-manager" set.
[root@k8s-master01 pki]# 
```



**Master01****使用某个环境当做默认环境**

```shell
[root@k8s-master01 pki]# kubectl config use-context system:kube-controller-manager@kubernetes \
> --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
Switched to context "system:kube-controller-manager@kubernetes".
[root@k8s-master01 pki]# cfssl gencert \
> -ca=/etc/kubernetes/pki/ca.pem \
> -ca-key=/etc/kubernetes/pki/ca-key.pem \
> -config=ca-config.json \
> -profile=kubernetes \
> scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler
2023/09/01 01:14:36 [INFO] generate received request
2023/09/01 01:14:36 [INFO] received CSR
2023/09/01 01:14:36 [INFO] generating key: rsa-2048
2023/09/01 01:14:36 [INFO] encoded CSR
2023/09/01 01:14:36 [INFO] signed certificate with serial number 88018517488547413954267519985609730397109488269
2023/09/01 01:14:36 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for
websites. For more information see the Baseline Requirements for the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);
specifically, section 10.2.3 ("Information Requirements").
[root@k8s-master01 pki]#
```



注意，如果不是高可用集群，192.168.15.88:8443改为master01的地址，8443改为apiserver的端口，默认是6443

**Master01** **设置**

```shell
[root@k8s-master01 pki]# kubectl config set-cluster kubernetes \
>      --certificate-authority=/etc/kubernetes/pki/ca.pem \
>      --embed-certs=true \
>      --server=https://192.168.15.88:8443 \
>      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
Cluster "kubernetes" set.
[root@k8s-master01 pki]# kubectl config set-credentials system:kube-scheduler \
>      --client-certificate=/etc/kubernetes/pki/scheduler.pem \
>      --client-key=/etc/kubernetes/pki/scheduler-key.pem \
>      --embed-certs=true \
>      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
User "system:kube-scheduler" set.
[root@k8s-master01 pki]# kubectl config set-context system:kube-scheduler@kubernetes \
>      --cluster=kubernetes \
>      --user=system:kube-scheduler \
>      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
Context "system:kube-scheduler@kubernetes" created.
[root@k8s-master01 pki]# kubectl config use-context system:kube-scheduler@kubernetes \
>      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
Switched to context "system:kube-scheduler@kubernetes".
[root@k8s-master01 pki]# cfssl gencert \
>    -ca=/etc/kubernetes/pki/ca.pem \
>    -ca-key=/etc/kubernetes/pki/ca-key.pem \
>    -config=ca-config.json \
>    -profile=kubernetes \
>    admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin
2023/09/01 01:16:13 [INFO] generate received request
2023/09/01 01:16:13 [INFO] received CSR
2023/09/01 01:16:13 [INFO] generating key: rsa-2048
2023/09/01 01:16:13 [INFO] encoded CSR
2023/09/01 01:16:13 [INFO] signed certificate with serial number 660421027543221851817737469949130636763120428998
2023/09/01 01:16:13 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for
websites. For more information see the Baseline Requirements for the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);
specifically, section 10.2.3 ("Information Requirements").
[root@k8s-master01 pki]#
```



注意，如果不是高可用集群，192.168.15.88：8443改为master01的地址，8443改为apiserver的端口，默认是6443

**Master01** **配置**

```shell
[root@k8s-master01 pki]# kubectl config set-cluster kubernetes     \
> --certificate-authority=/etc/kubernetes/pki/ca.pem     \
> --embed-certs=true     \
> --server=https://192.168.15.88:8443     \
> --kubeconfig=/etc/kubernetes/admin.kubeconfig
Cluster "kubernetes" set.
[root@k8s-master01 pki]# kubectl config set-credentials kubernetes-admin     \
> --client-certificate=/etc/kubernetes/pki/admin.pem     \
> --client-key=/etc/kubernetes/pki/admin-key.pem     \
> --embed-certs=true     \
> --kubeconfig=/etc/kubernetes/admin.kubeconfig
User "kubernetes-admin" set.
[root@k8s-master01 pki]# kubectl config set-context kubernetes-admin@kubernetes     --cluster=kubernetes     --user=kubernetes-admin     --kubeconfig=/etc/kubernetes/admin.kubeconfig
Context "kubernetes-admin@kubernetes" created.
[root@k8s-master01 pki]# kubectl config use-context kubernetes-admin@kubernetes     --kubeconfig=/etc/kubernetes/admin.kubeconfig
Switched to context "kubernetes-admin@kubernetes".
[root@k8s-master01 pki]# 
```



**Master01****创建ServiceAccount Key =》secret**

```shell
[root@k8s-master01 pki]# openssl genrsa -out /etc/kubernetes/pki/sa.key 2048
Generating RSA private key, 2048 bit long modulus (2 primes)
............+++++
.............................................................................+++++
e is 65537 (0x010001)
[root@k8s-master01 pki]# openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub
writing RSA key
[root@k8s-master01 pki]# 
```



**Master01****发送证书至其他节点**

```shell
[root@k8s-master01 pki]# for NODE in k8s-master02 k8s-master03; do >   for FILE in $(ls /etc/kubernetes/pki | grep -v etcd); do 
>     scp /etc/kubernetes/pki/${FILE} $NODE:/etc/kubernetes/pki/${FILE};
>   done; 
>   for FILE in admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig; do 
>     scp /etc/kubernetes/${FILE} $NODE:/etc/kubernetes/${FILE};
>   done;
> done
```



**查看证书文件**

```shell
[root@k8s-master01 pki]# ls /etc/kubernetes/pki/
admin.csr                   front-proxy-ca.csr
admin-key.pem               front-proxy-ca-key.pem
admin.pem                   front-proxy-ca.pem
apiserver.csr               front-proxy-client.csr
apiserver-key.pem           front-proxy-client-key.pem
apiserver.pem               front-proxy-client.pem
ca.csr                      sa.key
ca-key.pem                  sa.pub
ca.pem                      scheduler.csr
controller-manager.csr      scheduler-key.pem
controller-manager-key.pem  scheduler.pem
controller-manager.pem
[root@k8s-master01 pki]# ls /etc/kubernetes/pki/ |wc -l
23
[root@k8s-master01 pki]# 
```

此处建议打快照！

# 第五章 高可用配置

高可用配置（注意：如果不是高可用集群，haproxy和keepalived无需安装）

如果在云上安装也无需执行此章节的步骤，可以直接使用云上的lb，比如阿里云slb，腾讯云elb等

公有云要用公有云自带的负载均衡，比如阿里云的SLB，腾讯云的ELB，用来替代haproxy和keepalived，因为公有云大部分都是不支持keepalived的。



**所有Master节点****安装keepalived和haproxy**

```shell
[root@k8s-master01 ~]# yum install keepalived haproxy -y
```



## 5.1 HAProxy 配置

**所有Master****配置HAProxy，配置一样**

**（注意修改 IP）**

```shell
[root@k8s-master01 ~]# vim /etc/haproxy/haproxy.cfg
global
  maxconn  2000
  ulimit-n  16384
  log  127.0.0.1 local0 err
  stats timeout 30s

defaults
  log global
  mode  http
  option  httplog
  timeout connect 5000
  timeout client  50000
  timeout server  50000
  timeout http-request 15s
  timeout http-keep-alive 15s

frontend k8s-master
  bind 0.0.0.0:8443
  bind 127.0.0.1:8443
  mode tcp
  option tcplog
  tcp-request inspect-delay 5s
  default_backend k8s-master

backend k8s-master
  mode tcp
  option tcplog
  option tcp-check
  balance roundrobin
  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
  server k8s-master01    192.168.15.101:6443  check
  server k8s-master02    192.168.15.102:6443  check
  server k8s-master03    192.168.15.103:6443  check
```

## 5.1 Keepalived 配置

**所有Master节点配置KeepAlived，配置不一样，注意区分**

【注意每个节点的IP、VIP和网卡（interface参数），在此只列出一台 master01 的配置】

```shell
[root@k8s-master01 ~]# vim /etc/keepalived/keepalived.conf

! Configuration File for keepalived
global_defs {
    router_id LVS_DEVEL
}
vrrp_script chk_apiserver {
    script "/etc/keepalived/check_apiserver.sh"
    interval 5 
    weight -5
    fall 2
    rise 1
}
vrrp_instance VI_1 {
    state MASTER
    interface ens32
    mcast_src_ip 192.168.15.101
    virtual_router_id 51
    priority 101
    nopreempt
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.15.88
    }
    track_script {
      chk_apiserver 
} }
```

## 5.2 健康检查配置

**所有master节点**

```shell
[root@k8s-master01 ~]# vim /etc/keepalived/check_apiserver.sh

#!/bin/bash

err=0
for k in $(seq 1 3)
do
    check_code=$(pgrep haproxy)
    if [[ $check_code == "" ]]; then
        err=$(expr $err + 1)
        sleep 1
        continue
    else
        err=0
        break
    fi
done

if [[ $err != "0" ]]; then
    echo "systemctl stop keepalived"
    /usr/bin/systemctl stop keepalived
    exit 1
else
    exit 0
fi
[root@k8s-master01 ~]# chmod +x /etc/keepalived/check_apiserver.sh
[root@k8s-master01 ~]# 
```



**所有master节点****启动haproxy和keepalived**

```shell
[root@k8s-master01 ~]# systemctl daemon-reload
[root@k8s-master01 ~]# systemctl enable --now haproxy
Created symlink /etc/systemd/system/multi-user.target.wants/haproxy.service → /usr/lib/systemd/system/haproxy.service.
[root@k8s-master01 ~]# systemctl enable --now keepalived
Created symlink /etc/systemd/system/multi-user.target.wants/keepalived.service → /usr/lib/systemd/system/keepalived.service.
[root@k8s-master01 ~]#
```



**VIP测试**

```shell
[root@k8s-master01 ~]# ping 192.168.15.88 -c 3
PING 192.168.100.69 (192.168.100.69) 56(84) bytes of data.
64 bytes from 192.168.15.88: icmp_seq=1 ttl=64 time=0.052 ms
64 bytes from 192.168.15.88: icmp_seq=2 ttl=64 time=0.046 ms
64 bytes from 192.168.15.88: icmp_seq=3 ttl=64 time=0.114 ms

--- 192.168.100.69 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2044ms
rtt min/avg/max/mdev = 0.046/0.070/0.114/0.032 ms
[root@k8s-master01 ~]#
```



**重要：**如果安装了keepalived和haproxy，需要测试keepalived是否是正常的！

```shell
[root@k8s-master01 ~]# telnet 192.168.15.88 8443
Trying 192.168.15.88...
Connected to 192.168.15.88.
Escape character is '^]'.
Connection closed by foreign host.
[root@k8s-master01 ~]#
```



**如果ping不通且telnet没有出现 '^]'，则认为VIP不可以，不可在继续往下执行，需要排查keepalived的问题**。比如防火墙和 selinux，haproxy和keepalived 的状态，监听端口等

**所有节点****查看防火墙状态必须为disable和inactive：systemctl status firewalld**

**所有节点****查看selinux状态，必须为disable：getenforce**

**master节点****查看haproxy和keepalived状态：systemctl status keepalived haproxy**

**master节点****查看监听端口：netstat -lntp**

# 第六章 Kubernetes组件配置

## 6.1 etcd配置

**etcd配置大致相同，注意修改每个Master节点的etcd配置的主机名和IP地址**

### 6.1.1 master01

当前只列出一台 master01 的配置，02、03 修改 IP 即可

```shell
[root@k8s-master01 ~]# vim /etc/etcd/etcd.config.yml
name: 'k8s-master01'
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.15.101:2380'
listen-client-urls: 'https://192.168.15.101:2379,http://127.0.0.1:2379'
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.15.101:2380'
advertise-client-urls: 'https://192.168.15.101:2379'
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'k8s-master01=https://192.168.15.101:2380,k8s-master02=https://192.168.15.102:2380,k8s-master03=https://192.168.15.103:2380'
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
```

### 6.1.2 创建service

**所有Master节点****创建etcd service并启动**

```shell
[root@k8s-master01 ~]# vim /usr/lib/systemd/system/etcd.service

[Unit]
Description=Etcd Service
Documentation=https://coreos.com/etcd/docs/latest/
After=network.target

[Service]
Type=notify
ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml
Restart=on-failure
RestartSec=10
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
Alias=etcd3.service
```



**所有Master节点****创建etcd的证书目录**

```shell
[root@k8s-master01 ~]# mkdir /etc/kubernetes/pki/etcd
[root@k8s-master01 ~]# ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/
[root@k8s-master01 ~]# systemctl daemon-reload
[root@k8s-master01 ~]# systemctl enable --now etcd
Created symlink /etc/systemd/system/etcd3.service → /usr/lib/systemd/system/etcd.service.
Created symlink /etc/systemd/system/multi-user.target.wants/etcd.service → /usr/lib/systemd/system/etcd.service.
[root@k8s-master01 ~]#
```



**查看etcd状态**

```shell
[root@k8s-master01 ~]# export ETCDCTL_API=3
[root@k8s-master01 ~]# etcdctl --endpoints="192.168.15.103:2379,192.168.15.102:2379,192.168.15.101:2379" \
> --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem \
> --cert=/etc/kubernetes/pki/etcd/etcd.pem \
> --key=/etc/kubernetes/pki/etcd/etcd-key.pem  \
> endpoint status --write-out=table
+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
|      ENDPOINT       |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
| 192.168.100.63:2379 | a1dc876ddb79d945 |   3.5.9 |   20 kB |     false |      false |         2 |          8 |                  8 |        |
| 192.168.100.62:2379 | 94fc7c634260ffca |   3.5.9 |   20 kB |     false |      false |         2 |          8 |                  8 |        |
| 192.168.100.61:2379 | 578060df8daece21 |   3.5.9 |   20 kB |      true |      false |         2 |          8 |                  8 |        |
+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
[root@k8s-master01 ~]# 
```



## 6.2 API Server

**所有Master节点****创建kube-apiserver service**

\# 注意，如果不是高可用集群，192.168.15.88 改为master01的地址



**master01****配置 API Server 程序控制脚本**

注意使用的k8s service网段为10.96.0.0/16，该网段不能和宿主机的网段、Pod网段的重复，请按需修改

在此只列出 master01 配置，其他 master 节点按照该配置修改 IP 即可

```shell
[root@k8s-master01 ~]# vim /usr/lib/systemd/system/kube-apiserver.service
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver \
      --v=2  \
      --allow-privileged=true  \
      --bind-address=0.0.0.0  \
      --secure-port=6443  \
      --advertise-address=192.168.15.101 \
      --service-cluster-ip-range=10.96.0.0/16  \
      --service-node-port-range=30000-32767  \
      --etcd-servers=https://192.168.15.101:2379,https://192.168.15.102:2379,https://192.168.15.103:2379 \
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \
      --client-ca-file=/etc/kubernetes/pki/ca.pem  \
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \
      --service-account-issuer=https://kubernetes.default.svc.cluster.local \
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \
      --authorization-mode=Node,RBAC  \
      --enable-bootstrap-token-auth=true  \
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \
      --requestheader-allowed-names=aggregator  \
      --requestheader-group-headers=X-Remote-Group  \
      --requestheader-extra-headers-prefix=X-Remote-Extra-  \
      --requestheader-username-headers=X-Remote-User
      # --token-auth-file=/etc/kubernetes/token.csv

Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
[root@k8s-master01 ~]# systemctl daemon-reload
[root@k8s-master01 ~]# systemctl enable --now kube-apiserver
Created symlink /etc/systemd/system/multi-user.target.wants/kube-apiserver.service → /usr/lib/systemd/system/kube-apiserver.service.
[root@k8s-master01 ~]# 
```



**检测kube-server状态**

```shell
[root@k8s-master01 ~]# systemctl status kube-apiserver
● kube-apiserver.service - Kubernetes API Server
   Loaded: loaded (/usr/lib/systemd/system/kube-apiserver.service;>
   Active: active (running) since Fri 2023-09-01 13:54:46 CST; 38s>
     Docs: https://github.com/kubernetes/kubernetes
 Main PID: 3164 (kube-apiserver)
    Tasks: 7 (limit: 11057)
   Memory: 296.3M
   CGroup: /system.slice/kube-apiserver.service
           └─3164 /usr/local/bin/kube-apiserver --v=2 --allow-priv>

9月 01 13:54:53 k8s-master01 kube-apiserver[3164]: I0901 13:54:53.>
9月 01 13:54:53 k8s-master01 kube-apiserver[3164]: I0901 13:54:53.>
9月 01 13:54:53 k8s-master01 kube-apiserver[3164]: I0901 13:54:53.>
9月 01 13:54:53 k8s-master01 kube-apiserver[3164]: I0901 13:54:53.>
9月 01 13:54:53 k8s-master01 kube-apiserver[3164]: [-]poststarthoo>
9月 01 13:54:54 k8s-master01 kube-apiserver[3164]: E0901 13:54:54.>
9月 01 13:55:04 k8s-master01 kube-apiserver[3164]: W0901 13:55:04.>
9月 01 13:55:04 k8s-master01 kube-apiserver[3164]: I0901 13:55:04.>
9月 01 13:55:04 k8s-master01 kube-apiserver[3164]: I0901 13:55:04.>
9月 01 13:55:20 k8s-master01 kube-apiserver[3164]: I0901 13:55:20.>
[root@k8s-master01 ~]#
```



## 6.3 Controller Manager

**所有Master节点****配置kube-controller-manager service（所有master节点配置一样）**

注意使用的k8s Pod网段为172.16.0.0/16，该网段不能和宿主机的网段、k8s Service网段的重复，请按需修改

```shell
[root@k8s-master01 ~]# vim /usr/lib/systemd/system/kube-controller-manager.service
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-controller-manager \
      --v=2 \
      --root-ca-file=/etc/kubernetes/pki/ca.pem \
      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \
      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \
      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \
      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \
      --authentication-kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \
      --authorization-kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \
      --leader-elect=true \
      --use-service-account-credentials=true \
      --node-monitor-grace-period=40s \
      --node-monitor-period=5s \
      --controllers=*,bootstrapsigner,tokencleaner \
      --allocate-node-cidrs=true \
      --cluster-cidr=172.16.0.0/16 \
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \
      --node-cidr-mask-size=24
      
Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target
```



**所有Master节点****启动kube-controller-manager**

```shell
[root@k8s-master01 ~]# systemctl daemon-reload
[root@k8s-master01 ~]# systemctl enable --now kube-controller-manager
Created symlink /etc/systemd/system/multi-user.target.wants/kube-controller-manager.service → /usr/lib/systemd/system/kube-controller-manager.service.
[root@k8s-master01 ~]# systemctl  status kube-controller-manager
● kube-controller-manager.service - Kubernetes Controller Manager
   Loaded: loaded (/usr/lib/systemd/system/kube-controller-manager>
   Active: active (running) since Fri 2023-09-01 14:01:21 CST; 52s>
     Docs: https://github.com/kubernetes/kubernetes
 Main PID: 3649 (kube-controller)
    Tasks: 5 (limit: 11057)
   Memory: 132.2M
   CGroup: /system.slice/kube-controller-manager.service
           └─3649 /usr/local/bin/kube-controller-manager --v=2 --r>

9月 01 14:01:22 k8s-master01 kube-controller-manager[3649]: I0901 >
9月 01 14:01:22 k8s-master01 kube-controller-manager[3649]: I0901 >
9月 01 14:01:22 k8s-master01 kube-controller-manager[3649]: I0901 >
9月 01 14:01:22 k8s-master01 kube-controller-manager[3649]: I0901 >
9月 01 14:01:22 k8s-master01 kube-controller-manager[3649]: I0901 >
9月 01 14:01:22 k8s-master01 kube-controller-manager[3649]: I0901 >
9月 01 14:01:22 k8s-master01 kube-controller-manager[3649]: I0901 >
9月 01 14:01:22 k8s-master01 kube-controller-manager[3649]: I0901 >
9月 01 14:01:22 k8s-master01 kube-controller-manager[3649]: I0901 >
9月 01 14:01:22 k8s-master01 kube-controller-manager[3649]: I0901 >
lines 1-20/20 (END)
```

## 6.4 Scheduler

**所有Master节点****配置kube-scheduler service（所有master节点配置一样）**

```shell
[root@k8s-master01 ~]# cat /usr/lib/systemd/system/kube-scheduler.service
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-scheduler \
      --v=2 \
      --leader-elect=true \
      --authentication-kubeconfig=/etc/kubernetes/scheduler.kubeconfig \
      --authorization-kubeconfig=/etc/kubernetes/scheduler.kubeconfig \
      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target
[root@k8s-master01 ~]# systemctl daemon-reload
[root@k8s-master01 ~]# systemctl enable --now kube-scheduler
Created symlink /etc/systemd/system/multi-user.target.wants/kube-scheduler.service → /usr/lib/systemd/system/kube-scheduler.service.
[root@k8s-master01 ~]# systemctl status kube-scheduler
● kube-scheduler.service - Kubernetes Scheduler
   Loaded: loaded (/usr/lib/systemd/system/kube-scheduler.service;>
   Active: active (running) since Fri 2023-09-01 14:04:15 CST; 5s >
     Docs: https://github.com/kubernetes/kubernetes
 Main PID: 3857 (kube-scheduler)
    Tasks: 7 (limit: 11057)
   Memory: 71.2M
   CGroup: /system.slice/kube-scheduler.service
           └─3857 /usr/local/bin/kube-scheduler --v=2 --leader-ele>

9月 01 14:04:17 k8s-master01 kube-scheduler[3857]: I0901 14:04:17.>
9月 01 14:04:17 k8s-master01 kube-scheduler[3857]: I0901 14:04:17.>
9月 01 14:04:17 k8s-master01 kube-scheduler[3857]: I0901 14:04:17.>
9月 01 14:04:17 k8s-master01 kube-scheduler[3857]: I0901 14:04:17.>
9月 01 14:04:17 k8s-master01 kube-scheduler[3857]: I0901 14:04:17.>
9月 01 14:04:17 k8s-master01 kube-scheduler[3857]: I0901 14:04:17.>
9月 01 14:04:17 k8s-master01 kube-scheduler[3857]: I0901 14:04:17.>
9月 01 14:04:17 k8s-master01 kube-scheduler[3857]: I0901 14:04:17.>
9月 01 14:04:17 k8s-master01 kube-scheduler[3857]: I0901 14:04:17.>
9月 01 14:04:17 k8s-master01 kube-scheduler[3857]: I0901 14:04:17.>
[root@k8s-master01 ~]#
```

# 第七章 TLS Bootstrapping配置

TLS Bootstrapping（TLS 引导）是一种机制，用于在 Kubernetes 集群中自动为节点（Node）颁发和配置安全传输所需的 TLS 证书。

注意，如果不是高可用集群，192.168.15.88:8443改为master01的地址，8443改为apiserver的端口，默认是6443



**Master01****创建bootstrap**

```shell
[root@k8s-master01 ~]# cd /root/k8s-ha-install/bootstrap
[root@k8s-master01 bootstrap]# kubectl config set-cluster kubernetes     \
> --certificate-authority=/etc/kubernetes/pki/ca.pem     \
> --embed-certs=true     \
> --server=https://192.168.15.88:8443     \
> --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig
Cluster "kubernetes" set.
[root@k8s-master01 bootstrap]# kubectl config set-credentials tls-bootstrap-token-user     \
> --token=c8ad9c.2e4d610cf3e7426e \
> --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig
User "tls-bootstrap-token-user" set.
[root@k8s-master01 bootstrap]# kubectl config set-context tls-bootstrap-token-user@kubernetes     \
> --cluster=kubernetes     \
> --user=tls-bootstrap-token-user     \
> --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig
Context "tls-bootstrap-token-user@kubernetes" created.
[root@k8s-master01 bootstrap]# kubectl config use-context tls-bootstrap-token-user@kubernetes     --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig
Switched to context "tls-bootstrap-token-user@kubernetes".
[root@k8s-master01 bootstrap]# mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config
[root@k8s-master01 bootstrap]# 
```



**可以正常查询集群状态，才可以继续往下，否则不行，需要排查k8s组件是否有故障**

```shell
[root@k8s-master01 bootstrap]# kubectl get cs
Warning: v1 ComponentStatus is deprecated in v1.19+
NAME                 STATUS    MESSAGE   ERROR
scheduler            Healthy   ok        
controller-manager   Healthy   ok        
etcd-0               Healthy   ok        
[root@k8s-master01 bootstrap]# kubectl create -f bootstrap.secret.yaml 
secret/bootstrap-token-c8ad9c created
clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created
clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-bootstrap created
clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-certificate-rotation created
clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created
clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created
[root@k8s-master01 bootstrap]#
```

# 第八章 Node节点配置

## 8.1 复制证书

**Master01节点****复制证书至Node节点**

```shell
[root@k8s-master01 ~]# cd /etc/kubernetes/
[root@k8s-master01 kubernetes]# for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do
>      ssh $NODE mkdir -p /etc/kubernetes/pki
>      for FILE in pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig; do
>        scp /etc/kubernetes/$FILE $NODE:/etc/kubernetes/${FILE}
>  done
>  done
ca.pem                                         100% 1411   611.5KB/s   00:00    
ca-key.pem                                     100% 1675   560.3KB/s   00:00    
front-proxy-ca.pem                             100% 1143   738.2KB/s   00:00    
bootstrap-kubelet.kubeconfig                   100% 2301   598.7KB/s   00:00    
ca.pem                                         100% 1411   529.5KB/s   00:00    
ca-key.pem                                     100% 1675   417.6KB/s   00:00    
front-proxy-ca.pem                             100% 1143   307.8KB/s   00:00    
bootstrap-kubelet.kubeconfig                   100% 2301   603.5KB/s   00:00    
ca.pem                                         100% 1411   404.2KB/s   00:00    
ca-key.pem                                     100% 1675   515.8KB/s   00:00    
front-proxy-ca.pem                             100% 1143   380.2KB/s   00:00    
bootstrap-kubelet.kubeconfig                   100% 2301   550.5KB/s   00:00    
ca.pem                                         100% 1411   645.2KB/s   00:00    
ca-key.pem                                     100% 1675     1.4MB/s   00:00    
front-proxy-ca.pem                             100% 1143     1.2MB/s   00:00    
bootstrap-kubelet.kubeconfig                   100% 2301   760.2KB/s   00:00    
[root@k8s-master01 kubernetes]# 
```

## 8.2 Kubelet配置

**所有节点****创建相关目录**

```shell
[root@k8s-master01 ~]# mkdir -p /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/
[root@k8s-master01 ~]# 
```



**所有节点****配置kubelet service**

```shell
[root@k8s-master01 ~]# vim  /usr/lib/systemd/system/kubelet.service

[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kubelet

Restart=always
StartLimitInterval=0
RestartSec=10

[Install]
WantedBy=multi-user.target
```



**所有节点****配置kubelet service的配置文件**

（也可以写到kubelet.service）

```shell
[root@k8s-master01 ~]# vim /etc/systemd/system/kubelet.service.d/10-kubelet.conf

[Service]
Environment="KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig"
Environment="KUBELET_SYSTEM_ARGS=--container-runtime-endpoint=unix:///run/containerd/containerd.sock"
Environment="KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml"
Environment="KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node='' "
ExecStart=
ExecStart=/usr/local/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_SYSTEM_ARGS $KUBELET_EXTRA_ARGS
```



**所有节点****创建kubelet的配置文件**

注意：如果更改了k8s的service网段，需要更改kubelet-conf.yml 的clusterDNS:配置，改成k8s Service网段的第十个地址，比如10.96.0.10

```shell
[root@k8s-master01 ~]# vim /etc/kubernetes/kubelet-conf.yml
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
address: 0.0.0.0
port: 10250
readOnlyPort: 10255
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 2m0s
    enabled: true
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.pem
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
cgroupDriver: systemd
cgroupsPerQOS: true
clusterDNS:
- 10.96.0.10
clusterDomain: cluster.local
containerLogMaxFiles: 5
containerLogMaxSize: 10Mi
contentType: application/vnd.kubernetes.protobuf
cpuCFSQuota: true
cpuManagerPolicy: none
cpuManagerReconcilePeriod: 10s
enableControllerAttachDetach: true
enableDebuggingHandlers: true
enforceNodeAllocatable:
- pods
eventBurst: 10
eventRecordQPS: 5
evictionHard:
  imagefs.available: 15%
  memory.available: 100Mi
  nodefs.available: 10%
  nodefs.inodesFree: 5%
evictionPressureTransitionPeriod: 5m0s
failSwapOn: true
fileCheckFrequency: 20s
hairpinMode: promiscuous-bridge
healthzBindAddress: 127.0.0.1
healthzPort: 10248
httpCheckFrequency: 20s
imageGCHighThresholdPercent: 85
imageGCLowThresholdPercent: 80
imageMinimumGCAge: 2m0s
iptablesDropBit: 15
iptablesMasqueradeBit: 14
kubeAPIBurst: 10
kubeAPIQPS: 5
makeIPTablesUtilChains: true
maxOpenFiles: 1000000
maxPods: 110
nodeStatusUpdateFrequency: 10s
oomScoreAdj: -999
podPidsLimit: -1
registryBurst: 10
registryPullQPS: 5
resolvConf: /etc/resolv.conf
rotateCertificates: true
runtimeRequestTimeout: 2m0s
serializeImagePulls: true
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 4h0m0s
syncFrequency: 1m0s
volumeStatsAggPeriod: 1m0s
[root@k8s-master01 ~]#
```



**启动****所有节点****kubelet**

```shell
[root@k8s-master01 ~]# systemctl daemon-reload
[root@k8s-master01 ~]# systemctl enable --now kubelet
Created symlink /etc/systemd/system/multi-user.target.wants/kubelet.service → /usr/lib/systemd/system/kubelet.service.
[root@k8s-master01 ~]# systemctl status kubelet
```

此时系统日志/var/log/messages显示只有如下两种信息为正常，安装calico后即可恢复

Unable to update cni config: no networks found in /etc/cni/net.d

![img](https://cdn.nlark.com/yuque/0/2023/png/27632550/1703143337385-e7bbcc71-6edd-4139-91f2-1a79fbc31461.png)

如果有很多报错日志，或者有大量看不懂的报错，说明kubelet的配置有误，需要检查kubelet配置



**查看集群状态(Ready 或 NotReady 都正常)**

```shell
[root@k8s-master01 ~]#  kubectl get node
NAME           STATUS     ROLES    AGE     VERSION
k8s-master01   NotReady   <none>   2m31s   v1.28.0
k8s-master02   NotReady   <none>   2m31s   v1.28.0
k8s-master03   NotReady   <none>   2m31s   v1.28.0
k8s-node01     NotReady   <none>   2m31s   v1.28.0
k8s-node02     NotReady   <none>   2m31s   v1.28.0
[root@k8s-master01 ~]#
```

## 8.3 kube-proxy配置

注意，如果不是高可用集群，192.168.15.88:8443改为master01的地址，8443改为apiserver的端口，默认是6443



**Master01****执行**

```shell
[root@k8s-master01 ~]# cd /root/k8s-ha-install/pki
[root@k8s-master01 pki]# cfssl gencert \
>    -ca=/etc/kubernetes/pki/ca.pem \
>    -ca-key=/etc/kubernetes/pki/ca-key.pem \
>    -config=ca-config.json \
>    -profile=kubernetes \
>    kube-proxy-csr.json | cfssljson -bare /etc/kubernetes/pki/kube-proxy
2023/09/01 20:58:25 [INFO] generate received request
2023/09/01 20:58:25 [INFO] received CSR
2023/09/01 20:58:25 [INFO] generating key: rsa-2048
2023/09/01 20:58:25 [INFO] encoded CSR
2023/09/01 20:58:25 [INFO] signed certificate with serial number 409810819523538273888266911652028641582986884038
2023/09/01 20:58:25 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for
websites. For more information see the Baseline Requirements for the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);
specifically, section 10.2.3 ("Information Requirements").
[root@k8s-master01 pki]# 
```



注意，如果不是高可用集群，192.168.100.69:8443改为master01的地址，8443改为apiserver的端口，默认是6443

**Master01****执行**

```shell
[root@k8s-master01 pki]# kubectl config set-cluster kubernetes \
>      --certificate-authority=/etc/kubernetes/pki/ca.pem \
>      --embed-certs=true \
>      --server=https://192.168.15.88:8443 \
>      --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig
Cluster "kubernetes" set.
[root@k8s-master01 pki]# kubectl config set-credentials system:kube-proxy \
>      --client-certificate=/etc/kubernetes/pki/kube-proxy.pem \
>      --client-key=/etc/kubernetes/pki/kube-proxy-key.pem \
>      --embed-certs=true \
>      --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig
User "system:kube-proxy" set.
[root@k8s-master01 pki]# kubectl config set-context system:kube-proxy@kubernetes \
>      --cluster=kubernetes \
>      --user=system:kube-proxy \
>      --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig
Context "system:kube-proxy@kubernetes" created.
[root@k8s-master01 pki]# kubectl config use-context system:kube-proxy@kubernetes \
>      --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig
Switched to context "system:kube-proxy@kubernetes".
[root@k8s-master01 pki]# 
```



**Master01****将kubeconfig发送至其他节点**

```shell
[root@k8s-master01 pki]# for NODE in k8s-master02 k8s-master03; do
>      scp /etc/kubernetes/kube-proxy.kubeconfig  $NODE:/etc/kubernetes/kube-proxy.kubeconfig
>  done
kube-proxy.kubeconfig                          100% 6482     1.7MB/s   00:00    
kube-proxy.kubeconfig                          100% 6482   218.3KB/s   00:00    
[root@k8s-master01 pki]# for NODE in k8s-node01 k8s-node02; do
>      scp /etc/kubernetes/kube-proxy.kubeconfig $NODE:/etc/kubernetes/kube-proxy.kubeconfig
>  done
kube-proxy.kubeconfig                          100% 6482     1.3MB/s   00:00    
kube-proxy.kubeconfig                          100% 6482     2.2MB/s   00:00    
[root@k8s-master01 pki]# 
```



**所有节点****添加kube-proxy的配置和service文件：**

```shell
[root@k8s-master01 pki]# vim /usr/lib/systemd/system/kube-proxy.service

[Unit]
Description=Kubernetes Kube Proxy
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-proxy \
  --config=/etc/kubernetes/kube-proxy.yaml \
  --v=2

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target
```



**如果更改了集群Pod的网段，需要****更改kube-proxy.yaml的clusterCIDR为更改后的Pod网段****：**

```shell
[root@k8s-master01 pki]# vim /etc/kubernetes/kube-proxy.yaml
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: 0.0.0.0
clientConnection:
  acceptContentTypes: ""
  burst: 10
  contentType: application/vnd.kubernetes.protobuf
  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig
  qps: 5
clusterCIDR: 172.16.0.0/16 
configSyncPeriod: 15m0s
conntrack:
  max: null
  maxPerCore: 32768
  min: 131072
  tcpCloseWaitTimeout: 1h0m0s
  tcpEstablishedTimeout: 24h0m0s
enableProfiling: false
healthzBindAddress: 0.0.0.0:10256
hostnameOverride: ""
iptables:
  masqueradeAll: false
  masqueradeBit: 14
  minSyncPeriod: 0s
  syncPeriod: 30s
ipvs:
  masqueradeAll: true
  minSyncPeriod: 5s
  scheduler: "rr"
  syncPeriod: 30s
kind: KubeProxyConfiguration
metricsBindAddress: 127.0.0.1:10249
mode: "ipvs"
nodePortAddresses: null
oomScoreAdj: -999
portRange: ""
udpIdleTimeout: 250ms
[root@k8s-master01 pki]#
```



**所有节点****启动kube-proxy**

```shell
[root@k8s-master01 pki]# systemctl daemon-reload
[root@k8s-master01 pki]# systemctl enable --now kube-proxy
Created symlink /etc/systemd/system/multi-user.target.wants/kube-proxy.service → /usr/lib/systemd/system/kube-proxy.service.
[root@k8s-master01 pki]# 
```

此时系统日志/var/log/messages显示只有如下两种信息为正常，安装calico后即可恢复

Unable to update cni config: no networks found in /etc/cni/net.d

![img](https://cdn.nlark.com/yuque/0/2023/png/27632550/1703143337712-ace805c7-cf6d-4baa-897c-cf278c02c17f.png)

# 第九章 安装Calico

## 9.1 安装官方推荐版本

**master01****执行**

```shell
[root@k8s-master01 pki]# cd /root/k8s-ha-install/calico/
[root@k8s-master01 calico]# ls
calico.yaml
```



**master01****更改calico的网段，主要需要将红色部分的网段，改为自己的Pod网段**

```shell
[root@k8s-master01 calico]# sed -i "s#POD_CIDR#172.16.0.0/16#g" calico.yaml
[root@k8s-master01 calico]# grep "IPV4POOL_CIDR" calico.yaml  -A 1
            - name: CALICO_IPV4POOL_CIDR
              value: "172.16.0.0/16"
[root@k8s-master01 calico]# kubectl apply -f calico.yaml
```

确保这个网段是自己的Pod网段



**master01****查看容器状态**

```shell
[root@k8s-master01 calico]# kubectl get po -n kube-system
NAME                                       READY   STATUS    RESTARTS   AGE
calico-kube-controllers-6d48795585-7bpnl   1/1     Running   0          95s
calico-node-k27fv                          1/1     Running   0          95s
calico-node-nzgms                          1/1     Running   0          95s
calico-node-pfw59                          1/1     Running   0          95s
calico-node-qrg2q                          1/1     Running   0          95s
calico-node-wts56                          1/1     Running   0          95s
[root@k8s-master01 calico]# 
```



**如果容器状态异常可以使用kubectl describe 或者kubectl logs查看容器的日志**

```shell
Kubectl logs -f POD_NAME -n kube-system
Kubectl logs -f POD_NAME -c upgrade-ipam -n kube-system 
```

# 第十章 安装CoreDNS

**master01****安装官方推荐版本**

```shell
[root@k8s-master01 ~]# cd /root/k8s-ha-install/
[root@k8s-master01 k8s-ha-install]# 
```



**如果更改了k8s service的网段需要将coredns的serviceIP改成k8s service网段的第十个IP（****master01 执行****）**

```shell
[root@k8s-master01 k8s-ha-install]# COREDNS_SERVICE_IP=`kubectl get svc | grep kubernetes | awk '{print $3}'`0
[root@k8s-master01 k8s-ha-install]# sed -i "s#KUBEDNS_SERVICE_IP#${COREDNS_SERVICE_IP}#g" CoreDNS/coredns.yaml
[root@k8s-master01 k8s-ha-install]# 
```



**master01****安装coredns**

```shell
[root@k8s-master01 k8s-ha-install]# kubectl  create -f CoreDNS/coredns.yaml
serviceaccount/coredns created
clusterrole.rbac.authorization.k8s.io/system:coredns created
clusterrolebinding.rbac.authorization.k8s.io/system:coredns created
configmap/coredns created
deployment.apps/coredns created
service/kube-dns created
[root@k8s-master01 k8s-ha-install]#
```



# 第十一章 安装Metrics Server

在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率。



**master01****安装metrics server**

```shell
[root@k8s-master01 k8s-ha-install]# cd /root/k8s-ha-install/metrics-server
[root@k8s-master01 metrics-server]# kubectl  create -f . 
serviceaccount/metrics-server created
clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created
clusterrole.rbac.authorization.k8s.io/system:metrics-server created
rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created
clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created
clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created
service/metrics-server created
deployment.apps/metrics-server created
apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created
[root@k8s-master01 metrics-server]# 
```



**等待metrics server启动然后查看状态**

```shell
[root@k8s-master01 metrics-server]# kubectl top node
NAME           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   
k8s-master01   436m         21%    936Mi           55%       
k8s-master02   434m         21%    992Mi           58%       
k8s-master03   160m         8%     929Mi           55%       
k8s-node01     113m         5%     687Mi           40%       
k8s-node02     108m         5%     770Mi           45%       
[root@k8s-master01 metrics-server]# 
```

如果有如下报错，可以等待10分钟后，再次查看：

Error from server (ServiceUnavailable): the server is currently unable to handle the request (get nodes.metrics.k8s.io)

# 第十二章 安装dashboard

## 12.1 Dashboard部署

Kubernetes Dashboard（仪表盘）是一个用于可视化管理和监控 Kubernetes 集群的 web UI 工具。它提供了一个用户友好的界面，用于查看和管理集群中的应用程序、服务、节点等重要资源。

Dashboard用于展示集群中的各类资源，同时也可以通过Dashboard实时查看Pod的日志和在容器中执行一些命令等。

### 12.1.1 安装指定版本dashboard

**Master01 执行**

```shell
[root@k8s-master01 metrics-server]# cd /root/k8s-ha-install/dashboard/
[root@k8s-master01 dashboard]# kubectl  create -f .
serviceaccount/admin-user created
clusterrolebinding.rbac.authorization.k8s.io/admin-user created
namespace/kubernetes-dashboard created
serviceaccount/kubernetes-dashboard created
service/kubernetes-dashboard created
secret/kubernetes-dashboard-certs created
secret/kubernetes-dashboard-csrf created
secret/kubernetes-dashboard-key-holder created
configmap/kubernetes-dashboard-settings created
role.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created
rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
deployment.apps/kubernetes-dashboard created
service/dashboard-metrics-scraper created
deployment.apps/dashboard-metrics-scraper created
[root@k8s-master01 dashboard]# 
```



### 12.1.2 登录dashboard

**Master01****更改dashboard的svc为NodePort**

```shell
[root@k8s-master01 dashboard]# kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard
```

![img](https://cdn.nlark.com/yuque/0/2023/png/27632550/1703143338021-8054c048-6a3f-4f50-b7ec-996f87aa463e.png)

将ClusterIP更改为NodePort（如果已经为NodePort忽略此步骤）



**Master01****查看端口号：**

```shell
[root@k8s-master01 dashboard]# kubectl get svc kubernetes-dashboard -n kubernetes-dashboard
NAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE
kubernetes-dashboard   NodePort   10.96.120.157   <none>        443:30237/TCP   4m55s
[root@k8s-master01 dashboard]# 
```

根据自己的实例端口号，通过任意安装了kube-proxy的**宿主机的IP+端口**即可访问到dashboard：

**访问Dashboard：**[**https://192.168.15.88:30237**](https://192.168.15.88:30237)**（请更改30237为自己的端口），选择登录方式为令牌（即token方式）**



![img](https://cdn.nlark.com/yuque/0/2023/png/27632550/1703143338528-87d8e108-904f-4bee-815b-5a59bdcf5ef5.png)



**Master01****创建登录Token：**

```shell
[root@k8s-master01 dashboard]# kubectl create token admin-user -n kube-system
eyJhbGciOiJSUzI1NiIsImtpZCI6Im9LMEFwQS11Rzc1YU40Zkp5QnVPY0p6akxiRktfZ0hNbWtZd1ZrMlh2UkUifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNjkzNTc4Nzg2LCJpYXQiOjE2OTM1NzUxODYsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiMzdiNWY2MjEtOTEzNC00NGYwLWIyY2UtZWViZWFlZmZlYjlhIn19LCJuYmYiOjE2OTM1NzUxODYsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTphZG1pbi11c2VyIn0.TFzNWCVfudxyNlmkbWrkc4d21bx4VqYmArvr3eUvNXl1DrKFUyDLUWMLyv7R-x1rHPb3avlJoA3Zn40LwiOHltV9blQypuHr52-bbzWbv5uy7Pa_vPw9LMELwZ4Vf7E807LLkhu0tTPCaL_iLbSFrLtZRkiJUGkVmfMZLeHAh4BzKi1DOxZhBCIgsbK-GTfQWSwn5bApwvD7fqMZTL4ou9oIq2CGELpp9eVEdwtqq80OKgiLfBA9KKYtmAlhbXAib_G1uNV4tN3XfdwkQwYx2ZDEazQ06y5tGmXlfcBIq4hH7rCN7Kl7Pvo3C0OEqucuJGHJ820uJyQ8yzqvPXzcrA
[root@k8s-master01 dashboard]# 
```



**将token值输入到令牌后，单击登录即可访问Dashboard：**

![img](https://cdn.nlark.com/yuque/0/2023/png/27632550/1703143338875-379310d4-cea9-4f54-8f7b-a9d4f46625b3.png)

# 第十三章 集群可用性验证

## 13.1 节点均正常

```shell
[root@k8s-master01 ~]# kubectl get node
NAME           STATUS   ROLES    AGE   VERSION
k8s-master01   Ready    <none>   47m   v1.28.0
k8s-master02   Ready    <none>   47m   v1.28.0
k8s-master03   Ready    <none>   47m   v1.28.0
k8s-node01     Ready    <none>   47m   v1.28.0
k8s-node02     Ready    <none>   47m   v1.28.0
[root@k8s-master01 ~]# 
```

## 13.2 Pod均正常

```shell
[root@k8s-master01 ~]# kubectl get po -A
NAMESPACE              NAME                                         READY   STATUS    RESTARTS      AGE
kube-system            calico-kube-controllers-6d48795585-7bpnl     1/1     Running   1 (23m ago)   28m
kube-system            calico-node-k27fv                            1/1     Running   1 (23m ago)   28m
kube-system            calico-node-nzgms                            1/1     Running   1 (22m ago)   28m
kube-system            calico-node-pfw59                            1/1     Running   1 (22m ago)   28m
kube-system            calico-node-qrg2q                            1/1     Running   1 (23m ago)   28m
kube-system            calico-node-wts56                            1/1     Running   1 (22m ago)   28m
kube-system            coredns-788958459b-gzrj7                     1/1     Running   0             18m
kube-system            metrics-server-8f77d49f6-fhcbj               1/1     Running   0             17m
kubernetes-dashboard   dashboard-metrics-scraper-7b554c884f-6wlcz   1/1     Running   0             13m
kubernetes-dashboard   kubernetes-dashboard-54b699784c-8s77s        1/1     Running   0             13m
[root@k8s-master01 ~]#
```

## 13.3 集群网段无任何冲突

```shell
[root@k8s-master01 ~]# kubectl get svc
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   7h45m
[root@k8s-master01 ~]# kubectl get po -A -owide
NAMESPACE              NAME                                         READY   STATUS    RESTARTS      AGE   IP               NODE           NOMINATED NODE   READINESS GATES
kube-system            calico-kube-controllers-6d48795585-7bpnl     1/1     Running   1 (23m ago)   29m   172.16.58.194    k8s-node02     <none>           <none>
kube-system            calico-node-k27fv                            1/1     Running   1 (23m ago)   29m   192.168.15.105   k8s-node02     <none>           <none>
kube-system            calico-node-nzgms                            1/1     Running   1 (23m ago)   29m   192.168.15.101   k8s-master01   <none>           <none>
kube-system            calico-node-pfw59                            1/1     Running   1 (23m ago)   29m   192.168.15.103   k8s-master03   <none>           <none>
kube-system            calico-node-qrg2q                            1/1     Running   1 (23m ago)   29m   192.168.15.104   k8s-node01     <none>           <none>
kube-system            calico-node-wts56                            1/1     Running   1 (23m ago)   29m   192.168.15.102   k8s-master02   <none>           <none>
kube-system            coredns-788958459b-gzrj7                     1/1     Running   0             19m   172.16.32.129    k8s-master01   <none>           <none>
kube-system            metrics-server-8f77d49f6-fhcbj               1/1     Running   0             17m   172.16.85.193    k8s-node01     <none>           <none>
kubernetes-dashboard   dashboard-metrics-scraper-7b554c884f-6wlcz   1/1     Running   0             14m   172.16.195.1     k8s-master03   <none>           <none>
kubernetes-dashboard   kubernetes-dashboard-54b699784c-8s77s        1/1     Running   0             14m   172.16.122.129   k8s-master02   <none>           <none>
[root@k8s-master01 ~]# 
```



## 13.4 能够正常创建资源

```shell
[root@k8s-master01 ~]# kubectl create deploy cluster-test --image=registry.cn-beijing.aliyuncs.com/dotbalo/debug-tools -- sleep 3600
deployment.apps/cluster-test created
[root@k8s-master01 ~]# kubectl get po
NAME                            READY   STATUS    RESTARTS   AGE
cluster-test-66bb44bd88-gkq8m   1/1     Running   0          100s
[root@k8s-master01 ~]# kubectl get po -owide
NAME                            READY   STATUS    RESTARTS   AGE    IP              NODE         NOMINATED NODE   READINESS GATES
cluster-test-66bb44bd88-gkq8m   1/1     Running   0          103s   172.16.85.194   k8s-node01   <none>           <none>
[root@k8s-master01 ~]# 
```



## 13.5 Pod必须能够解析Service（同namespace和跨namespace）



1. nslookup kubernetes

```shell
[root@k8s-master01 ~]# kubectl exec -it cluster-test-66bb44bd88-gkq8m -- bash
(13:58 cluster-test-66bb44bd88-gkq8m:/) nslookup kubernetes
Server:		10.96.0.10
Address:	10.96.0.10#53

Name:	kubernetes.default.svc.cluster.local
Address: 10.96.0.1   # 可以解析到server的IP地址说明同namespace可以解析

(13:58 cluster-test-66bb44bd88-gkq8m:/) 
```



**可以解析到server的IP地址说明同namespace可以解析**



1. nslookup kube-dns.kube-system



```shell
(13:58 cluster-test-66bb44bd88-gkq8m:/) nslookup kube-dns.kube-system
Server:		10.96.0.10
Address:	10.96.0.10#53

Name:	kube-dns.kube-system.svc.cluster.local
Address: 10.96.0.10   # 可以解析到server的第十个ip，说明可以解析到kube-dns

(14:00 cluster-test-66bb44bd88-gkq8m:/) 
```



**可以解析到server的第十个ip，说明可以解析到kube-dns，说明跨namespace也可解析**

## 13.6 每个节点都必须能访问Kubernetes的kubernetes svc 443 和kube-dns的service 53

```shell
[root@k8s-master01 ~]# curl https://10.96.0.1:443
curl: (60) SSL certificate problem: unable to get local issuer certificate
More details here: https://curl.haxx.se/docs/sslcerts.html

curl failed to verify the legitimacy of the server and therefore could not
establish a secure connection to it. To learn more about this situation and
how to fix it, please visit the web page mentioned above.
[root@k8s-master01 ~]# 
[root@k8s-master01 ~]# curl 10.96.0.10:53
curl: (52) Empty reply from server
[root@k8s-master01 ~]# 
```

## 13.7 Pod和Pod之间要能够正常通讯（同namespace和跨namespace）

```shell
[root@k8s-master01 ~]# kubectl get po -nkube-system -owide
NAME                                       READY   STATUS    RESTARTS      AGE   IP               NODE           NOMINATED NODE   READINESS GATES
calico-kube-controllers-6d48795585-7bpnl   1/1     Running   1 (61m ago)   66m   172.16.58.194    k8s-node02     <none>           <none>
calico-node-k27fv                          1/1     Running   1 (61m ago)   66m   192.168.15.105   k8s-node02     <none>           <none>
calico-node-nzgms                          1/1     Running   1 (61m ago)   66m   192.168.15.101   k8s-master01   <none>           <none>
calico-node-pfw59                          1/1     Running   1 (61m ago)   66m   192.168.15.103   k8s-master03   <none>           <none>
calico-node-qrg2q                          1/1     Running   1 (61m ago)   66m   192.168.15.104   k8s-node01     <none>           <none>
calico-node-wts56                          1/1     Running   1 (61m ago)   66m   192.168.15.102   k8s-master02   <none>           <none>
coredns-788958459b-gzrj7                   1/1     Running   0             56m   172.16.32.129    k8s-master01   <none>           <none>
metrics-server-8f77d49f6-fhcbj             1/1     Running   0             55m   172.16.85.193    k8s-node01     <none>           <none>
[root@k8s-master01 ~]# kubectl get po -owide
NAME                            READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES
cluster-test-66bb44bd88-gkq8m   1/1     Running   0          27m   172.16.85.194   k8s-node01   <none>           <none>
[root@k8s-master01 ~]# kubectl exec -it cluster-test-66bb44bd88-gkq8m -- bash
(14:18 cluster-test-66bb44bd88-gkq8m:/) ping 172.16.58.194 -c 3
PING 172.16.58.194 (172.16.58.194) 56(84) bytes of data.
64 bytes from 172.16.58.194: icmp_seq=1 ttl=62 time=0.643 ms
64 bytes from 172.16.58.194: icmp_seq=2 ttl=62 time=1.59 ms
64 bytes from 172.16.58.194: icmp_seq=3 ttl=62 time=1.44 ms

--- 172.16.58.194 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2024ms
rtt min/avg/max/mdev = 0.643/1.228/1.599/0.420 ms
(14:19 cluster-test-66bb44bd88-gkq8m:/) 
```

**进入node1节点的pod，ping测node2节点的pod可ping通**

## 13.8 Pod和Pod之间要能够正常通讯（同机器和跨机器）

**所有节点**

```shell
[root@k8s-master01 ~]# kubectl get po -owide
NAME                            READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES
cluster-test-66bb44bd88-gkq8m   1/1     Running   0          19m   172.16.85.194   k8s-node01   <none>           <none>
[root@k8s-master01 ~]# ping 172.16.85.194 -c 3		# 所有节点都要ping
PING 172.16.85.194 (172.16.85.194) 56(84) bytes of data.
64 bytes from 172.16.85.194: icmp_seq=1 ttl=63 time=0.574 ms
64 bytes from 172.16.85.194: icmp_seq=2 ttl=63 time=0.262 ms
64 bytes from 172.16.85.194: icmp_seq=3 ttl=63 time=0.479 ms

--- 172.16.85.194 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2041ms
rtt min/avg/max/mdev = 0.262/0.438/0.574/0.131 ms
[root@k8s-master01 ~]# 
```